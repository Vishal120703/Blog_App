<%- include('element/header') %>
<%- include('element/navbar') %>

<section class="container py-5">
  <div class="card shadow-lg p-4 mx-auto" style="max-width: 800px;">
    <% if (blog.image) { %>
      <img src="<%= blog.image %>" class="img-fluid rounded mb-4" alt="Blog Image">
    <% } %>
    <h2 class="text-primary mb-3"><%= blog.title %></h2>
    <p class="text-muted">By <%= blog.auther %> | <%= blog.date.toDateString() %></p>
    <hr>
    <p class="lead text-secondary"><%= blog.content %></p>
  </div>

  <button 
  id="likeBtn" 
  data-id="<%= blog._id %>" 
  class="btn btn-outline-danger mt-3">
  ‚ù§Ô∏è Like(<span id="likeCount"><%= blog.likes %></span>)
</button>

  <!-- ‚úÖ Comment Field -->
  
  <form id="commentForm" class="mt-4">
  <div class="mb-3">
    <textarea
      name="comment"
      id="comment"
      class="form-control"
      rows="3"
      placeholder="Write your comment..."
      required
    ></textarea>
  </div>
  <button type="submit" class="btn btn-primary">Post Comment</button>
</form>
  
  <div class="mt-5" id="commentsContainer" style="max-width: 800px;">
  <h4 class="mb-3">Comments</h4>

  <% blog.comments.forEach(comment => { %>
    <div class="card p-3 mb-2 shadow-sm">
      <strong><%= comment.user %></strong>
      <p class="mb-1"><%= comment.text %></p>
    </div>
  <% }) %>
</div>
</section>
<script>
document.getElementById("likeBtn").addEventListener("click", async function() {
    const postId = this.dataset.id;

    const res = await fetch(`/post/${postId}/like`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        }
    });

    const data = await res.json();

    if (data.success) {
        // Update like count instantly
        document.getElementById("likeCount").innerText = data.likes;

        // Change button text
        if (data.liked) {
            this.innerHTML = `‚ù§Ô∏è Liked (<span id="likeCount">${data.likes}</span>)`;
        } else {
            this.innerHTML = `ü§ç Like (<span id="likeCount">${data.likes}</span>)`;
        }
    }
});
</script>
<script>
document.getElementById("commentForm").addEventListener("submit", async function (e) {
    e.preventDefault(); // stop page reload

    const comment = document.getElementById("comment").value;
    const postId = "<%= blog._id %>";

    const res = await fetch(`/post/${postId}/comment`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ comment })
    });

    const data = await res.json();

    if (data.success) {
        // Add new comment instantly to DOM
        const container = document.getElementById("commentsContainer");

        const newCommentHTML = `
            <div class="card p-3 mb-2 shadow-sm">
                <strong>${data.comment.user}</strong>
                <p class="mb-1">${data.comment.text}</p>
            </div>
        `;

        container.innerHTML += newCommentHTML;

        // Clear textarea
        document.getElementById("comment").value = "";
    }
});
</script>


<%- include('element/footer') %>
